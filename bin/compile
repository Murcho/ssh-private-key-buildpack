#!/usr/bin/env bash

function indent() {
	c='s/^/       /'
	case $(uname) in
		Darwin) sed -l "$c";;
		*)      sed -u "$c";;
	esac
}

build_dir=$1
env_dir=$3
ssh_key="$(cat $env_dir/SSH_KEY)"
ssh_key_pub="$(cat $env_dir/SSH_KEY_PUB)"
ssh_key_id="$(cat $env_dir/SSH_KEY_ID)"

if [ "$ssh_key" != "" ]; then
	echo "-----> Running SSH private key setup"

	mkdir "$build_dir/.ssh"
	echo "$ssh_key" | base64 --decode > "$build_dir/.ssh/id_rsa"
	echo "$ssh_key_pub" | base64 --decode > "$build_dir/.ssh/id_rsa.pub"
	echo "Host git-codecommit.*.amazonaws.com
  User $ssh_key_id
  IdentityFile /app/.ssh/id_rsa" > "$build_dir/.ssh/config"
  	eval `ssh-agent -s`
  	chmod 600 $build_dir/.ssh/id_rsa
  	ssh-add $build_dir/.ssh/id_rsa
	ssh -i $build_dir/.ssh/id_rsa -o StrictHostKeyChecking=no git-codecommit.us-east-1.amazonaws.com
	exit 0
else
	echo "-----> No SSH private key"
fi
